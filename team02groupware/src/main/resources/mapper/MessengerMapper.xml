<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  		
	
<mapper namespace="com.team02.groupware.mapper.MessengerMapper">
	
	<!-- 채팅방 리스트 resultMap  -->
	<resultMap id="selectChatRoomList" type="map">
	
    	<result property="chatRoomCode" column="chat_room_code"/>
    	<result property="chatRoomTitle" column="chat_room_title"/>
    	<result property="chatRoomUserCount" column="chat_room_user_count"/>
    	<result property="chatMsgDate" column="chat_message_date"/>
    	<result property="chatMsgContent" column="chat_message_content"/>
    	<result property="chatMsgCode" column="chat_message_code"/>
    	
  	</resultMap>
	
	<!-- 채팅방 리스트 select -->
	<select id="selectChatRoomList" resultMap="selectChatRoomList" parameterType="String">
		SELECT
			crl.chat_room_code,
			crl.chat_room_title,
			crl.chat_room_user_count,
			date_format(msg.chat_message_date,'%Y-%m-%d %H:%i') as chat_message_date,
			msg.chat_message_content,
			msg.chat_message_code
		FROM
			(SELECT
				*
			FROM
				chat_room_per_user AS cru
			WHERE
				cru.chat_user_id = #{userId}) AS tb1
				
			INNER join
			
			(SELECT
				cc.chat_message_code,
				cc.chat_message_date,
				cc.chat_message_user_id,
				cc.chat_message_content,
				cc.chat_room_code,
				cc.chat_message_user_nickname
			FROM
				chat_message_log AS cc
				
				INNER JOIN
				
				(SELECT 
					MAX(chat_message_code) AS msc,
					chat_room_code
					FROM chat_message_log
					GROUP by
						chat_room_code) AS ccc
					on
					cc.chat_message_code
					=
					ccc.msc) AS msg
			on
			tb1.chat_room_code
			=
			msg.chat_room_code
			INNER join
			chat_room_list AS crl
			on
			tb1.chat_room_code
			=
			crl.chat_room_code
	
	</select>
	
	<!-- 채팅방 상세보기 resultMap  -->
	<resultMap id="selectChatRoomView" type="map">
	
    	<result property="chatMsgCode" column="chat_message_code"/>
    	<result property="chatMsgDate" column="chat_message_date"/>
    	<result property="chatMsgUserId" column="chat_message_user_id"/>
    	<result property="chatMsgUserNickName" column="chat_message_user_nickname"/>
    	<result property="chatMsgContent" column="chat_message_content"/>
    	
  	</resultMap>
  	
	<!-- 채팅방 상세보기 select -->
	<select id="selectChatRoomView" resultMap="selectChatRoomView" parameterType="String">
		SELECT 
			chat_message_code
			,date_format(chat_message_date,'%Y-%m-%d %H:%i') as chat_message_date
			,chat_message_user_id
			,chat_message_content
			,chat_message_user_nickname
			
		FROM 
			chat_message_log
		WHERE
			chat_room_code = ${roomCode}
	
	</select>
	
	<!-- 채팅 메시지 insert -->
	<insert id="insertChatMessage" parameterType="ChatMessage">
		
		INSERT 
			INTO chat_message_log
			
			(chat_message_code, 
			chat_message_date, 
			chat_message_user_id, 
			chat_message_content, 
			chat_room_code,
			chat_message_user_nickname)
			
		VALUES 
			(NULL, 
			NOW(), 
			#{userId}, 
			#{content}, 
			${chatRoomCode},
			#{userNickName})
		
	</insert>		

	<!-- 유저 리스트 resultMap  -->
	<resultMap id="selectUserList" type="map">
	
    	<result property="groupCode" column="group_code"/>
    	<result property="groupName" column="group_name"/>
    	<result property="userId" column="employee_id"/>
    	<result property="userNickName" column="employee_nickname"/>
    	<result property="userName" column="employee_name"/>
    	
  	</resultMap>
  	
	<!-- 유저 리스트 select -->
	<select id="selectUserList" resultMap="selectUserList" parameterType="String">
		SELECT
			eg.group_code,
			eg.group_name,
			sub1.employee_id,
			sub1.employee_nickname,
			sub1.employee_name
			
		FROM
			employee_group AS eg
			INNER join
			(SELECT
				e.employee_id,
				e.employee_code,
				e.employee_nickname,
				e.employee_name,
				ebg.group_code
			FROM
				employee AS e
				INNER join
				employee_by_group AS ebg
				on
				e.employee_code
				=
				ebg.employee_code) AS sub1
			on
			eg.group_code
			=
			sub1.group_code
			
		WHERE
			sub1.employee_id != #{userId}
			
		ORDER BY 
			sub1.group_code, 
			sub1.employee_nickname asc
	
	</select>
	
	
	<insert id="createChatRoom" parameterType="map">
		
		INSERT INTO 
			chat_room_list
			(chat_room_title, chat_room_user_count)
		VALUES 
			(#{roomName}, ${roomCount});
		<selectKey resultType="int" keyProperty="roomCode" order="AFTER">
			SELECT 
				max(chat_room_code) as roomCode
			FROM 
				chat_room_list
		</selectKey>
		
		
	</insert>
	
	<insert id="insertUserChatRoom" parameterType="map">
		
		INSERT INTO 
			chat_room_per_user
			(chat_user_id, chat_room_code)
		VALUES 
			<foreach collection="roomMember" item="item" separator=",">
			(
				#{item},
				${roomCode}
			)
			</foreach>
		
		
	</insert>	


</mapper>